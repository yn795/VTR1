<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>mp4box.js 改良版 (エラー時のメッセージ表示強化)</title>

  <!-- mp4box.js (CDN) -->
  <script src="https://unpkg.com/mp4box/dist/mp4box.all.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0; 
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    #status {
      text-align: center;
      font-weight: bold;
      margin: 15px 0;
      color: #666;
    }
    input[type="file"] {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
    }
    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: #fff;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    video {
      width: 100%;
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #downloadLink {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #downloadLink button {
      background-color: #2196F3;
      color: #fff;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
    }
    @media (max-width: 600px) {
      button {
        font-size: 14px;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>mp4box.js で動画結合</h1>
    <h2>（Error: undefined を回避）</h2>

    <!-- ファイル入力＆実行ボタン -->
    <input type="file" id="videoFiles" accept="video/mp4" multiple />
    <button id="mergeButton">結合開始</button>

    <!-- ステータス表示 -->
    <div id="status">準備完了</div>

    <!-- 結合後プレビュー -->
    <video id="mergedVideo" controls></video>

    <!-- ダウンロードボタン -->
    <div id="downloadLink">
      <button id="downloadBtn">結合動画をダウンロード</button>
    </div>
  </div>

  <script>
    const mergeButton = document.getElementById("mergeButton");
    const statusEl = document.getElementById("status");
    const mergedVideo = document.getElementById("mergedVideo");
    const downloadLinkDiv = document.getElementById("downloadLink");
    const downloadBtn = document.getElementById("downloadBtn");

    // 結合開始ボタン
    mergeButton.addEventListener("click", async () => {
      const files = document.getElementById("videoFiles").files;
      if (files.length < 2) {
        alert("動画ファイルは2つ以上選択してください。");
        return;
      }

      mergeButton.disabled = true;
      statusEl.textContent = "動画を読み込み、結合しています...";

      try {
        let mergedBuffer = null;

        // 選択された動画ファイルを順次読み込んで結合
        for (let i = 0; i < files.length; i++) {
          mergedBuffer = await parseAndAppend(files[i], mergedBuffer);
        }

        if (!mergedBuffer) {
          throw new Error("結合用バッファを作成できませんでした。");
        }

        // 結合したバッファを Blob化し、<video> で再生可能なURLを生成
        const mergedBlob = new Blob([mergedBuffer], { type: "video/mp4" });
        const mergedUrl = URL.createObjectURL(mergedBlob);

        // プレビューに設定
        mergedVideo.src = mergedUrl;

        // ダウンロードボタンを有効化
        downloadLinkDiv.style.display = "block";
        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = mergedUrl;
          a.download = "merged_video.mp4";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

        statusEl.textContent = "結合完了！（同じコーデック/解像度の場合のみ再生できます）";
      } catch (err) {
        // --- エラーをコンソールに出力しつつ、画面に詳細を表示 ---
        console.error("結合エラー:", err);
        // err が文字列またはオブジェクトかを判定してメッセージ化
        const errMsg = (typeof err === "object" && err?.message) ? err.message : String(err);
        statusEl.textContent = "エラー: " + errMsg;
        alert("エラーが発生しました: " + errMsg);
      } finally {
        mergeButton.disabled = false;
      }
    });

    /**
     * mp4box.js を用いてファイルを解析し、前の結合バッファに連結する
     * @param {File} file 
     * @param {ArrayBuffer|null} prevBuffer 
     * @returns {Promise<ArrayBuffer>} 新たに連結されたバッファ
     */
    function parseAndAppend(file, prevBuffer) {
      return new Promise(async (resolve, reject) => {
        statusEl.textContent = `解析中: ${file.name}`;
        const arrayBuffer = await file.arrayBuffer();

        // mp4boxのFileインスタンス
        const mp4boxfile = MP4Box.createFile();

        // onError でエラー時に必ず new Error(...) を投げる
        mp4boxfile.onError = (e) => {
          console.error("mp4box onError:", e);
          // 文字列の場合もオブジェクトの場合も、必ず new Error で包む
          const message = typeof e === "string" ? e : (e?.message || "不明なmp4boxエラー");
          reject(new Error(message));
        };

        // onReady で解析完了を受け取る
        mp4boxfile.onReady = (info) => {
          // 必要に応じて info.tracks を検証したりできる
          statusEl.textContent = `解析完了: ${file.name}`;
          // ここでは単純に前のバッファとの連結だけ行う
          const newBuffer = concatBuffer(prevBuffer, arrayBuffer);
          resolve(newBuffer);
        };

        // データを追加して解析を進める
        mp4boxfile.appendBuffer(arrayBuffer);
        mp4boxfile.flush();
      });
    }

    /**
     * ArrayBuffer を連結するヘルパー関数
     * @param {ArrayBuffer|null} buffer1 
     * @param {ArrayBuffer} buffer2 
     * @returns {ArrayBuffer}
     */
    function concatBuffer(buffer1, buffer2) {
      if (!buffer1) return buffer2.slice(0);
      if (!buffer2) return buffer1.slice(0);

      const tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);
      tmp.set(new Uint8Array(buffer1), 0);
      tmp.set(new Uint8Array(buffer2), buffer1.byteLength);
      return tmp.buffer;
    }
  </script>
</body>
</html>
